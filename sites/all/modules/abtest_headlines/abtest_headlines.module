<?php

/**
 * @file
 * Implements A/B Testing for the node bundle Blogs when checked to Engage the test (checkbox). And Fields for testing headlines are filled in
 * 
 * V.Charinas
 */

/**
 * Implements hook_menu().
 */

function abtest_headlines_menu() { 
  // This is just for testing module actualy tests will perform on front page
  $items = array();
  $items['abtest-headlines'] = array(
    'title' => 'A/B Headlines Test',
    'description' => 'Demonstrates using the abtest module.',
    'access callback' => TRUE,
    'page callback' => 'abtest_headlines_results_node_tab',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['node/%node/abtest'] = array(
    'title' => 'A/B Test',
    'description' => 'Demonstrates A/B Test Results.',
    //'access callback' => TRUE,//'_abtest_headlines_menu_access',
    'page callback' => 'abtest_headlines_results_node_tab',
    //'page callback' => '_abtest_headlines_menu_access',
    'access arguments' => array('access a/b test results'),
    'type' =>  MENU_LOCAL_TASK,
    'weight' => 10,
    
  );

    return $items;
}
/**
 * Implements hook_permission().
 */
function abtest_headlines_permission() {
  return array(
    'access a/b test results' => array(
      'title' => t('Access A/B test results'),
      'description' => t('May view Results for the node.'),
    ),
    
  );
}
/*
*  Implements EntityFieldQuery results
*/

function abtest_headlines_query_nodes() {

  //Query the nodes    
          $query = new EntityFieldQuery;
          $result = $query
          ->entityCondition('entity_type', 'node')
          ->entityCondition('bundle', 'blogs')
          ->propertyCondition('status', 1)
          ->fieldCondition('field_ab_test_boolean', 'value', 1, '=')
          ->fieldCondition('field_headline_a', 'value', '', '!=')
          ->fieldCondition('field_headline_b', 'value', '', '!=')
          ->execute();
  
  
          return $result;
  
  }

/*
*   Implements Node test result page but actualy that will be done by views
*/
  function abtest_headlines_results_node_tab() {
        //abtest_track_conversion('abtest_example'); //that will be counting results

       
        $node_id = '';
        $node_title ='';
        $headingA = '';
        $headingB = '';
        //$alias = drupal_get_path_alias('node/' . $node->nid);
        $queryA = array(
          
          'utm_source'=>'Home Page',
          'utm_medium'=>'website',
          'utm_campaign'=>'AB Test',
          'utm_content'=>'HeadlineA'
        );
        $queryB = array(
          
          'utm_source'=>'Home Page',
          'utm_medium'=>'website',
          'utm_campaign'=>'AB Test',
          'utm_content'=>'HeadlineB'
        );
        $output = '';//lets display them
        $output = array();
        //getting required nodes to test
        $nodes = array_keys( abtest_headlines_query_nodes()['node']); //reusing query in function
    
            foreach ($nodes as $node){
    
              $node = node_load($node);
              
              $node_id = $node->nid;
              $node_test_id ='abtest_headlines'.'_'.$node_id;
              $alias = drupal_get_path_alias('node/' . $node->nid);
              $headingA = $node->field_headline_a[LANGUAGE_NONE] [0] ['value']; // string to be removed
              $headingB = $node->field_headline_b[LANGUAGE_NONE] [0] ['value']; // string to be removed
              
                if (abtest($node_test_id)) {
        
                $node->title = $headingA;
               
                $node->path = array('alias' => $alias, 'query' => $queryA, 'pathauto' => FALSE, 'absolute' => TRUE); //node does not updating url because pathouto is active here  we need to turn it off. when pathouto is off url is updating but utm params not showing 
                  
                node_save($node);
               
              
              }
              else {
                //dpr ((int)$node_id);
                $node->title = $headingB;
               
                $node->path = array('alias' => $alias, 'query' => $queryB,'pathauto' => FALSE, 'absolute' => TRUE);  // Why query is not displays????
                node_save($node);
                //dpr ($node->path);
                

                
                
                
              }
             
              $view = node_view_multiple(node_load_multiple($nodes), 'teaser');
              $output = drupal_render($view);
      }
      return $output;
     
    }



  


