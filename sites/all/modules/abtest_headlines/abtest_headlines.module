<?php

/**
 * @file
 * Implements A/B Testing for the node bundle Blogs when checked to Engage the test (checkbox). And Fields for testing headlines are filled in
 * 
 * V.Charinas
 */

/**
 * Implements hook_menu().
 */

function abtest_headlines_menu() { 
  // This is just for testing module actualy tests will perform on front page
  $items = array();
  $items['abtest-headlines'] = array(
    'title' => 'A/B Headlines Test',
    'description' => 'Demonstrates using the abtest module.',
    'access callback' => TRUE,
    'page callback' => 'abtest_headlines_results_node_tab',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['node/%node/abtest'] = array(
    'title' => 'A/B Test',
    'description' => 'Demonstrates A/B Test Results.',
    //'access callback' => TRUE,//'_abtest_headlines_menu_access',
    'page callback' => 'abtest_headlines_results_node_tab',
    //'page callback' => '_abtest_headlines_menu_access',
    'access arguments' => array('access a/b test results'),
    'type' =>  MENU_LOCAL_TASK,
    'weight' => 10,
    
  );

    return $items;
}
/**
 * Implements hook_permission().
 */
function abtest_headlines_permission() {
  return array(
    'access a/b test results' => array(
      'title' => t('Access A/B test results'),
      'description' => t('May view Results for the node.'),
    ),
    
  );
}
/*
*  Implements EntityFieldQuery results
*/

function abtest_headlines_query_nodes() {

  //Query the nodes    
          $query = new EntityFieldQuery;
          $result = $query
          ->entityCondition('entity_type', 'node')
          ->entityCondition('bundle', 'blogs')
          ->propertyCondition('status', 1)
          ->fieldCondition('field_ab_test_boolean', 'value', 1, '=')
          ->fieldCondition('field_headline_a', 'value', '', '!=')
          ->fieldCondition('field_headline_b', 'value', '', '!=')
          ->execute();
  
  
          return $result;
  
  }

/*
*   Implements test page
*/
  function abtest_headlines_results_node_tab() {
        //abtest_track_conversion('abtest_example'); //that will be counting results

       
        $node_id = '';
        $node_title ='';
        $headingA = '';
        $headingB = '';
        $output = '';//lets display them
        //getting required nodes to test
        $nodes = array_keys( abtest_headlines_query_nodes()['node']); //reusing query in function
    
            foreach ($nodes as $node){
    
              $node = node_load($node);
              
              $node_id = $node->nid;
              $node_test_id ='abtest_headlines'.'_'.$node_id;
              $headingA = $node->field_headline_a[LANGUAGE_NONE] [0] ['value']; // string to be removed
              $headingB = $node->field_headline_b[LANGUAGE_NONE] [0] ['value']; // string to be removed
              //Output will be removed when it will be unnessesary 
              $output .= '<p>'.$node_id.'</p>';
              $output .= '<h4>'.$node_test_id. '</h4>';
              
              //it is not real test but emulating behaviour 
              if ((int)$node_id > 21) {
                
        
                $node->title = $headingA;
                $path = url(drupal_get_path_alias('node/' . $node->nid), array(
                    'query' => array (
                    'utm_source'=>'Home Page',
                    'utm_medium'=>'website',
                    'utm_campaign'=>'AB Test',
                    'utm_content'=>'HeadlineA'),
                    'absolute' => TRUE,
                  )
                );
                $node->path = array('alias' => $path); //node does not updating url because pathouto is active here  we need to turn it off.
                  
                node_save($node);
              //dpr ($path); $node->path = array('alias' => $path);
              
              $output .= '<h3>'.t('TITLE VARIANT A: ').$node->title.'</h3>'.'<p>'.$node->path['alias'].'</p>';
              
              }
              else {
                //dpr ((int)$node_id);
                $node->title = $headingB;
                $path = url(drupal_get_path_alias('node/' . $node->nid), array(
                  'query' => array (
                  'utm_source'=>'Home Page',
                  'utm_medium'=>'website',
                  'utm_campaign'=>'AB Test',
                  'utm_content'=>'HeadlineB'),
                  'absolute' => TRUE,
                )
              );
                $node->path = array('alias' => $path);
                node_save($node);
                
                $output .= '<h3>'.t('TITLE VARIANT B: ').$node->title.'</h3>'.'<p>'.$node->path['alias'].'</p>';
                
              }
       
      }
      return $output;
      //return node_view_multiple($nodes, 'teaser');
    }



  
 /**
  * Generates A/B test for the Nodes 
  */

 
//  function abtest_headlines_nodes() {


//     // test variations in core WOW  SOLUTION 
//     if (abtest('$node_test_id')){

//         //Variation Headline A
//          $node_title = $headingA;
//          $Url = $Url.$ga_tracking_path_A;

//     }
//     else{

//         //Variation Headline B
//        $node_title = $headingB;
//        $Url = $Url.$ga_tracking_path_B;


//     }

//     return $output;

//  }

